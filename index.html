<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pariksha Setu - Admin Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hide { display: none !important; }
        .card-custom { border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: none; background: white; }
        .sidebar { min-height: 100vh; background: #fff; border-right: 1px solid #e3e6f0; transition: all 0.3s; }
        .nav-item-custom { padding: 15px 20px; cursor: pointer; color: #5a5c69; margin: 5px 10px; border-radius: 5px; transition: 0.2s; }
        .nav-item-custom:hover, .nav-item-custom.active { background-color: #4e73df; color: white; }
        @media (max-width: 768px) {
            .sidebar { position: fixed; z-index: 1000; left: -250px; height: 100%; width: 250px; }
            .sidebar.show { left: 0; }
            .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
            .overlay.show { display: block; }
        }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #4e73df; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .correct-ans { background-color: #d1e7dd; border-color: #badbcc; color: #0f5132; }
        .wrong-ans { background-color: #f8d7da; border-color: #f5c2c7; color: #842029; }
        .chat-admin-box { height: 400px; display: flex; flex-direction: column; border: 1px solid #ddd; border-radius: 8px; background: white; }
        .chat-list { flex: 1; overflow-y: auto; border-right: 1px solid #eee; }
        .chat-view { flex: 2; display: flex; flex-direction: column; background: #f8f9fc; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 15px; }
        .msg { padding: 8px 12px; border-radius: 15px; margin-bottom: 8px; max-width: 70%; font-size: 14px; }
        .msg.admin { background: #4e73df; color: white; align-self: flex-end; margin-left: auto; }
        .msg.student { background: #e3e6f0; color: #333; align-self: flex-start; }
    </style>
</head>
<body>

    <div id="loadingScreen" class="text-center pt-5">
        <div class="loader"></div>
        <p class="text-muted">Loading Admin Portal...</p>
    </div>

    <div id="mobileHeader" class="d-md-none p-3 bg-white shadow-sm d-flex justify-content-between align-items-center sticky-top hide">
        <h5 class="m-0 text-primary fw-bold">Admin Portal</h5>
        <button class="btn btn-outline-primary" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    </div>
    <div class="overlay" onclick="toggleSidebar()"></div>

    <div class="container mt-5 hide" id="authSection">
        <div class="row justify-content-center">
            <div class="col-md-5 col-12">
                <div class="card card-custom p-4 p-md-5">
                    <div class="text-center mb-4">
                        <i class="fas fa-user-shield text-primary fa-3x mb-2"></i>
                        <h2 class="fw-bold">PARIKSHA SETU</h2>
                        <h3 style="color: #0D6EFD;">Admin Portal</h3>
                    </div>
                    <form id="formAdminLogin">
                        <input type="text" id="aBrand" class="form-control mb-3" placeholder="School Code" required>
                        <input type="email" id="aEmail" class="form-control mb-3" placeholder="Email" required>
                        <input type="password" id="aPass" class="form-control mb-3" placeholder="Password" required>
                        <button class="btn btn-primary w-100 mb-3">Login</button>
                        <div class="text-center small"><a href="#" onclick="switchForm('reg')">Register New School</a></div>
                    </form>
                    <form id="formRegCompany" class="hide">
                        <input type="text" id="rcName" class="form-control mb-3" placeholder="School Name" required>
                        <input type="text" id="rcBrand" class="form-control mb-3" placeholder="Create School Code" required>
                        <input type="email" id="rcEmail" class="form-control mb-3" placeholder="Email" required>
                        <input type="password" id="rcPass" class="form-control mb-3" placeholder="Password" required>
                        <button class="btn btn-primary w-100 mb-3">Register</button>
                        <div class="text-center small"><a href="#" onclick="switchForm('login')">Back to Login</a></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid hide" id="adminPanel">
        <div class="row">
            <div class="col-md-2 sidebar p-0 pt-3" id="sidebar">
                <h5 class="fw-bold text-center mb-4 text-primary d-none d-md-block">Admin<span class="text-dark">Portal</span></h5>
                <div class="nav-item-custom active" onclick="tab('students', this)"><i class="fas fa-users me-2"></i> Students</div>
                <div class="nav-item-custom" onclick="tab('exams', this)"><i class="fas fa-file-alt me-2"></i> Exams</div>
                <div class="nav-item-custom" onclick="tab('res', this)"><i class="fas fa-trophy me-2"></i> Results</div>
                <div class="nav-item-custom" onclick="tab('support', this)"><i class="fas fa-headset me-2"></i> Support</div>
                <div class="nav-item-custom text-danger mt-5" onclick="location.reload()"><i class="fas fa-sign-out-alt me-2"></i> Logout</div>
            </div>
            <div class="col-md-10 p-3 p-md-4" style="background: #f8f9fa;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Dashboard</h3>
                    <span class="badge bg-white text-primary p-2 shadow-sm">School Code: <span id="displayBrand" class="fw-bold"></span></span>
                </div>

                <div id="view-students" class="admin-view">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card card-custom p-4">
                                <h5>Add Student</h5>
                                <form id="addStudentForm">
                                    <input type="text" id="newStName" class="form-control mb-2" placeholder="Full Name" required>
                                    <input type="date" id="newStDob" class="form-control mb-2" required>
                                    <label class="small text-muted">ID Construction:</label>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text small">Prefix</span>
                                        <input type="text" id="newStPrefix" class="form-control" value="MVMN" required>
                                    </div>
                                    <div class="row g-2 mb-2">
                                        <div class="col-4"><input type="text" id="newStClass" class="form-control" placeholder="Cls" required></div>
                                        <div class="col-4"><input type="text" id="newStRoll" class="form-control" placeholder="Roll" required></div>
                                        <div class="col-4"><input type="text" id="newStSec" class="form-control" placeholder="Sec (A/N)"></div>
                                    </div>
                                    <input type="text" id="newStYear" class="form-control mb-3" placeholder="Year (26)" required>
                                    <div class="alert alert-secondary small p-2 mb-3">ID: <b id="previewId">...</b></div>
                                    <button class="btn btn-primary w-100">Add Student</button>
                                </form>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card card-custom p-4">
                                <div class="d-flex justify-content-between mb-3 align-items-center flex-wrap gap-2">
                                    <h5 class="m-0">Enrolled Students</h5>
                                    <div>
                                        <button onclick="deleteAllStudents()" class="btn btn-danger btn-sm me-2"><i class="fas fa-trash"></i> Delete All</button>
                                        <button onclick="exportStudents()" class="btn btn-success btn-sm"><i class="fas fa-file-excel"></i> Export Excel</button>
                                    </div>
                                </div>
                                
                                <!-- Student Filter Section -->
                                <div class="mb-3">
                                    <button class="btn btn-outline-primary btn-sm w-100 mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#studentFilterPanel">
                                        <i class="fas fa-filter"></i> Filter / Search Students
                                    </button>
                                    <div class="collapse" id="studentFilterPanel">
                                        <div class="card card-body bg-light p-3">
                                            <div class="row g-2">
                                                <div class="col-md-4"><input id="fsInput" class="form-control form-control-sm" placeholder="ID or Name"></div>
                                                <div class="col-md-2"><input id="fsClass" class="form-control form-control-sm" placeholder="Class"></div>
                                                <div class="col-md-2"><input id="fsSection" class="form-control form-control-sm" placeholder="Sec"></div>
                                                <div class="col-md-2"><input id="fsRoll" class="form-control form-control-sm" placeholder="Roll"></div>
                                                <div class="col-md-2">
                                                    <select id="fsBlock" class="form-select form-select-sm">
                                                        <option value="">All Status</option>
                                                        <option value="false">Active</option>
                                                        <option value="true">Blocked</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">DOB</span>
                                                        <input type="date" id="fsDob" class="form-control">
                                                    </div>
                                                </div>
                                                <div class="col-md-8 text-end">
                                                    <button onclick="applyStudentFilters()" class="btn btn-primary btn-sm">Search</button>
                                                    <button onclick="clearStudentFilters()" class="btn btn-outline-secondary btn-sm">Clear</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table align-middle">
                                        <thead><tr><th>ID</th><th>Name</th><th>Class</th><th>Action</th></tr></thead>
                                        <tbody id="studentListBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-exams" class="admin-view hide">
                    <div class="card card-custom p-4">
                        <div class="d-flex justify-content-between mb-3">
                            <h5>Manage Exams</h5>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createExamModal">+ Create Exam Draft</button>
                        </div>
                        <div id="examListAdmin" class="row"></div>
                    </div>
                </div>

                <div id="view-res" class="admin-view hide">
                    <div class="card card-custom p-4">
                        <div class="d-flex justify-content-between mb-3 align-items-center">
                            <h5>Student Results & Proctor Logs</h5>
                            <button onclick="deleteAllResults()" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete All Results</button>
                        </div>
                        
                        <!-- Result Filter Section -->
                        <div class="mb-3">
                            <button class="btn btn-outline-primary btn-sm w-100 mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#resultFilterPanel">
                                <i class="fas fa-filter"></i> Filter / Search Results
                            </button>
                            <div class="collapse" id="resultFilterPanel">
                                <div class="card card-body bg-light p-3">
                                    <div class="row g-2">
                                        <div class="col-md-4"><input id="frInput" class="form-control form-control-sm" placeholder="Search ID, Name or Exam"></div>
                                        <div class="col-md-2"><input id="frClass" class="form-control form-control-sm" placeholder="Class"></div>
                                        <div class="col-md-2"><input id="frSection" class="form-control form-control-sm" placeholder="Sec"></div>
                                        <div class="col-md-2"><input id="frRoll" class="form-control form-control-sm" placeholder="Roll"></div>
                                        <div class="col-md-2"><input type="number" id="frStrikes" class="form-control form-control-sm" placeholder="Min Strikes"></div>
                                        <div class="col-md-4">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">DOB</span>
                                                <input type="date" id="frDob" class="form-control">
                                            </div>
                                        </div>
                                        <div class="col-md-8 text-end">
                                            <button onclick="applyResultFilters()" class="btn btn-primary btn-sm">Search</button>
                                            <button onclick="clearResultFilters()" class="btn btn-outline-secondary btn-sm">Clear</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>Exam</th>
                                        <th>Student</th>
                                        <th>Score</th>
                                        <th>Time Taken</th>
                                        <th>Rank</th>
                                        <th>Strikes</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="resultBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-support" class="admin-view hide">
                    <div class="card card-custom p-4">
                        <h5>Student Issues & Live Chat</h5>
                        <div class="row mt-3">
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="list-group" id="ticketList"></div>
                            </div>
                            <div class="col-md-8">
                                <div class="chat-admin-box hide" id="adminChatBox">
                                    <div class="p-3 border-bottom bg-light d-flex justify-content-between">
                                        <strong id="activeChatUser">Student Name</strong>
                                        <button onclick="deleteTicket()" class="btn btn-sm btn-outline-danger">Delete Chat</button>
                                    </div>
                                    <div class="chat-msgs d-flex flex-column" id="adminChatMsgs"></div>
                                    <div class="p-2 border-top bg-white d-flex gap-2">
                                        <input id="adminChatInput" class="form-control" placeholder="Reply...">
                                        <button onclick="adminSend()" class="btn btn-primary">Send</button>
                                    </div>
                                </div>
                                <div id="adminChatPlaceholder" class="text-center text-muted p-5">Select a ticket to view chat</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="createExamModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Create Exam Draft</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <form id="createExamForm">
            <input class="form-control mb-2" id="ceTitle" placeholder="Title" required>
            <div class="row g-2 mb-2">
                <div class="col-6"><input class="form-control" id="ceClass" placeholder="Target Class" required></div>
                <div class="col-6"><input class="form-control" id="ceSubject" placeholder="Subject" required></div>
            </div>
            <div class="row g-2 mb-2">
                <div class="col-4"><input type="number" class="form-control" id="ceTotalQ" placeholder="Total Qs" required></div>
                <div class="col-4"><input type="number" class="form-control" id="ceDuration" placeholder="Mins" required></div>
                <div class="col-4"><input type="number" class="form-control" id="ceMarks" placeholder="Marks/Q" required></div>
            </div>
            <textarea class="form-control mb-2" id="ceInst" placeholder="Instructions" rows="3" required></textarea>
            <button class="btn btn-primary w-100">Create Draft</button>
        </form>
    </div></div></div></div>

    <div class="modal fade" id="unifiedEditModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">Edit Exam & Questions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 border-end">
                            <h6 class="text-muted fw-bold mb-3">Exam Details</h6>
                            <form id="editExamForm">
                                <input type="hidden" id="edId">
                                <label class="small">Title</label><input class="form-control mb-2" id="edTitle" required>
                                <div class="row g-2 mb-2">
                                    <div class="col-6"><label class="small">Class</label><input class="form-control" id="edClass" required></div>
                                    <div class="col-6"><label class="small">Subject</label><input class="form-control" id="edSubject" required></div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-6"><label class="small">Total Qs</label><input type="number" class="form-control" id="edTotalQ" required></div>
                                    <div class="col-6"><label class="small">Mins</label><input type="number" class="form-control" id="edDuration" required></div>
                                </div>
                                <label class="small">Marks/Q</label><input type="number" class="form-control mb-2" id="edMarks" required>
                                <label class="small">Instructions</label><textarea class="form-control mb-3" id="edInst" rows="3" required></textarea>
                                <button class="btn btn-warning w-100 mb-3">Update Details</button>
                            </form>
                            <hr>
                            <h6 class="text-muted fw-bold mb-3">Schedule</h6>
                            <input type="datetime-local" id="schStart" class="form-control mb-2">
                            <input type="datetime-local" id="schEnd" class="form-control mb-3">
                            <button onclick="saveSchedule()" class="btn btn-info w-100">Update Schedule</button>
                        </div>
                        
                        <div class="col-md-8">
                            <h6 class="text-muted fw-bold mb-3">Manage Questions</h6>
                            <form id="addQuesForm" class="mb-3 border p-3 bg-light rounded">
                                <input type="hidden" id="qEditId"> 
                                <textarea id="qText" class="form-control mb-2" placeholder="Question Text" required></textarea>
                                <div class="row g-2 mb-2">
                                    <div class="col-6"><input id="opt1" class="form-control form-control-sm" placeholder="Option A" required></div>
                                    <div class="col-6"><input id="opt2" class="form-control form-control-sm" placeholder="Option B" required></div>
                                    <div class="col-6"><input id="opt3" class="form-control form-control-sm" placeholder="Option C" required></div>
                                    <div class="col-6"><input id="opt4" class="form-control form-control-sm" placeholder="Option D" required></div>
                                </div>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">Correct</span>
                                    <select id="qCorrect" class="form-select">
                                        <option value="1">Option A</option><option value="2">Option B</option>
                                        <option value="3">Option C</option><option value="4">Option D</option>
                                    </select>
                                    <button id="btnSaveQ" class="btn btn-success">Add Question</button>
                                    <button type="button" onclick="cancelEditQ()" id="btnCancelQ" class="btn btn-secondary hide">Cancel</button>
                                </div>
                            </form>
                            <div class="overflow-auto" style="max-height: 500px;">
                                <ul id="modalQuestionsList" class="list-group"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="trackModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Track Exam Status</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="trackExamId"><div class="d-flex justify-content-between mb-2"><strong>Students in Class: <span id="trackClass"></span></strong><button onclick="refreshTrack()" id="btnRefreshTrack" class="btn btn-sm btn-outline-secondary"><i class="fas fa-sync"></i> Refresh</button></div><table class="table table-sm"><thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Action</th></tr></thead><tbody id="trackBody"></tbody></table></div></div></div></div>
    <div class="modal fade" id="viewResultModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Student Answer Sheet</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="viewResultBody"></div></div></div></div>
    <div class="modal fade" id="editStudentModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Student</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="editStDocId"><label>Name</label><input type="text" id="editStName" class="form-control mb-2"><label>DOB</label><input type="date" id="editStDob" class="form-control mb-2"><label>Class</label><input type="text" id="editStClass" class="form-control mb-2"><button onclick="saveStudentEdit()" class="btn btn-primary w-100">Update Details</button></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, where, getDocs, writeBatch, arrayUnion, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const CONFIG = { apiKey: "AIzaSyAY4UiCeRmEBSaihVwp8ka1RUCI8-ulydo", authDomain: "mvmn-quiz-app.firebaseapp.com", projectId: "mvmn-quiz-app", storageBucket: "mvmn-quiz-app.firebasestorage.app", messagingSenderId: "1092444917636", appId: "1:1092444917636:web:fba469d1c8f77d678f97d1" };

        window.db = null; window.user = null; window.activeExamId = null; 
        window.allStudents = []; window.allResults = [];
        let activeTicketId = null; let chatUnsub = null;

        const init = async () => {
            const app = initializeApp(CONFIG);
            const auth = getAuth(app);
            window.db = getFirestore(app);
            await signInAnonymously(auth);
            onAuthStateChanged(auth, u => { if(u) { document.getElementById('loadingScreen').classList.add('hide'); document.getElementById('authSection').classList.remove('hide'); }});
        };

        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('show'); document.querySelector('.overlay').classList.toggle('show'); };
        window.switchForm = (t) => { document.getElementById('formAdminLogin').classList.toggle('hide', t==='reg'); document.getElementById('formRegCompany').classList.toggle('hide', t==='login'); };

        document.getElementById('formAdminLogin').onsubmit = async (e) => {
            e.preventDefault();
            const brand = document.getElementById('aBrand').value.trim();
            onSnapshot(query(collection(window.db, 'companies'), where('brand','==',brand), where('email','==',document.getElementById('aEmail').value.trim()), where('pass','==',document.getElementById('aPass').value.trim())), snap => {
                if(!snap.empty) { window.user = snap.docs[0].data(); initAdmin(); } else Swal.fire('Error','Invalid Admin','error');
            });
        };
        
        document.getElementById('formRegCompany').onsubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(window.db, 'companies'), { name: document.getElementById('rcName').value, brand: document.getElementById('rcBrand').value, email: document.getElementById('rcEmail').value, pass: document.getElementById('rcPass').value });
            Swal.fire('Success','Registered','success'); window.switchForm('login');
        };

        const initAdmin = () => { document.getElementById('authSection').classList.add('hide'); document.getElementById('adminPanel').classList.remove('hide'); document.getElementById('mobileHeader').classList.remove('hide'); document.getElementById('displayBrand').innerText = window.user.brand; loadStudents(); loadExams(); loadResults(); loadSupport(); };
        window.tab = (t, el) => { document.querySelectorAll('.admin-view').forEach(v => v.classList.add('hide')); document.querySelectorAll('.nav-item-custom').forEach(n => n.classList.remove('active')); document.getElementById('view-'+t).classList.remove('hide'); el.classList.add('active'); if(window.innerWidth<768) toggleSidebar(); };

        // STUDENTS logic
        const genId = () => { document.getElementById('previewId').innerText = `${document.getElementById('newStPrefix').value||'MVMN'}${document.getElementById('newStClass').value||'CL'}${document.getElementById('newStRoll').value||'00'}${document.getElementById('newStSec').value||'N'}${document.getElementById('newStYear').value||'YY'}`; };
        ['newStPrefix','newStClass','newStRoll','newStSec','newStYear'].forEach(id => document.getElementById(id).addEventListener('input', genId));
        
        document.getElementById('addStudentForm').onsubmit = async (e) => { 
            e.preventDefault(); 
            await addDoc(collection(window.db, 'students'), { 
                brand: window.user.brand, name: document.getElementById('newStName').value, dob: document.getElementById('newStDob').value, 
                prefix: document.getElementById('newStPrefix').value, class: document.getElementById('newStClass').value, 
                roll: document.getElementById('newStRoll').value, section: document.getElementById('newStSec').value, 
                year: document.getElementById('newStYear').value, id: document.getElementById('previewId').innerText, 
                blocked: false, sessionId: null 
            }); 
            Swal.fire('Added', '', 'success'); document.getElementById('addStudentForm').reset(); genId(); 
        };

        const loadStudents = () => { 
            onSnapshot(query(collection(window.db, 'students'), where('brand','==',window.user.brand)), snap => { 
                window.allStudents = snap.docs.map(d => ({docId: d.id, ...d.data()}));
                window.cachedStudents = window.allStudents; // Sync for other functions
                applyStudentFilters(); // Render with current filters
            }); 
        };

        window.renderStudents = (list) => {
            document.getElementById('studentListBody').innerHTML = list.map(s => `<tr><td class="fw-bold">${s.id}</td><td>${s.name}</td><td>${s.class}</td><td><button onclick="editSt('${s.docId}','${s.name}','${s.dob}','${s.class}')" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></button> <button onclick="toggleBlock('${s.docId}',${!s.blocked})" class="btn btn-sm btn-outline-${s.blocked?'success':'warning'}">${s.blocked?'Unblock':'Block'}</button> <button onclick="deleteSt('${s.docId}','${s.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        };

        window.applyStudentFilters = () => {
            const txt = document.getElementById('fsInput').value.toLowerCase();
            const cls = document.getElementById('fsClass').value.toLowerCase();
            const sec = document.getElementById('fsSection').value.toLowerCase();
            const roll = document.getElementById('fsRoll').value.toLowerCase();
            const blk = document.getElementById('fsBlock').value;
            const dob = document.getElementById('fsDob').value;

            const filtered = window.allStudents.filter(s => {
                const matchTxt = !txt || s.id.toLowerCase().includes(txt) || s.name.toLowerCase().includes(txt);
                const matchCls = !cls || s.class.toLowerCase().includes(cls);
                const matchSec = !sec || (s.section || '').toLowerCase().includes(sec);
                const matchRoll = !roll || (s.roll || '').toLowerCase().includes(roll);
                const matchDob = !dob || s.dob === dob;
                const matchBlk = blk === "" || String(s.blocked) === blk;

                return matchTxt && matchCls && matchSec && matchRoll && matchDob && matchBlk;
            });

            window.renderStudents(filtered);
        };

        window.clearStudentFilters = () => {
            document.getElementById('fsInput').value = ''; document.getElementById('fsClass').value = '';
            document.getElementById('fsSection').value = ''; document.getElementById('fsRoll').value = '';
            document.getElementById('fsBlock').value = ''; document.getElementById('fsDob').value = '';
            window.renderStudents(window.allStudents);
        };

        window.toggleBlock = async (id, val) => await updateDoc(doc(window.db, 'students', id), { blocked: val, sessionId: null });
        window.deleteSt = async (docId, studentId) => { if(confirm('Delete Student and ALL their results?')) { await deleteDoc(doc(window.db, 'students', docId)); const q = query(collection(window.db, 'results'), where('studentId', '==', studentId)); const snap = await getDocs(q); const batch = writeBatch(window.db); snap.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); Swal.fire('Deleted', '', 'success'); } };
        window.editSt = (docId, name, dob, cls) => { document.getElementById('editStDocId').value = docId; document.getElementById('editStName').value = name; document.getElementById('editStDob').value = dob; document.getElementById('editStClass').value = cls; new bootstrap.Modal(document.getElementById('editStudentModal')).show(); };
        window.saveStudentEdit = async () => { await updateDoc(doc(window.db, 'students', document.getElementById('editStDocId').value), { name: document.getElementById('editStName').value, dob: document.getElementById('editStDob').value, class: document.getElementById('editStClass').value }); bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide(); Swal.fire('Updated', '', 'success'); };
        
        window.exportStudents = () => { 
            if(!window.allStudents?.length) return Swal.fire('Empty', '', 'info'); 
            const data = window.allStudents.map(s => ({ 
                ID: s.id, Name: s.name, DOB: s.dob, Class: s.class, 
                Section: s.section || '-', RollNo: s.roll || '-', 
                Blocked: s.blocked ? 'Yes':'No' 
            }));
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Students");
            XLSX.writeFile(wb, "Students.xlsx"); 
        };

        window.deleteAllStudents = async () => {
            if(!confirm('DANGER: This will delete ALL students and ALL their results permanently for this brand. Cannot be undone. Continue?')) return;
            const btn = document.activeElement;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            btn.disabled = true;
            try {
                const sQ = query(collection(window.db, 'students'), where('brand', '==', window.user.brand));
                const sSnap = await getDocs(sQ);
                const rQ = query(collection(window.db, 'results'), where('brand', '==', window.user.brand));
                const rSnap = await getDocs(rQ);
                const allDocs = [...sSnap.docs, ...rSnap.docs];
                const chunkSize = 500;
                for (let i = 0; i < allDocs.length; i += chunkSize) {
                    const chunk = allDocs.slice(i, i + chunkSize);
                    const batch = writeBatch(window.db);
                    chunk.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                }
                Swal.fire('Deleted', 'All students and associated results deleted.', 'success');
            } catch(e) { console.error(e); Swal.fire('Error', 'Failed to delete all data.', 'error'); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        };

        window.deleteAllResults = async () => {
            if(!confirm('DANGER: This will delete ALL student results permanently. Continue?')) return;
            const btn = document.activeElement;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            btn.disabled = true;
            try {
                const rQ = query(collection(window.db, 'results'), where('brand', '==', window.user.brand));
                const rSnap = await getDocs(rQ);
                const chunkSize = 500;
                for (let i = 0; i < rSnap.docs.length; i += chunkSize) {
                    const chunk = rSnap.docs.slice(i, i + chunkSize);
                    const batch = writeBatch(window.db);
                    chunk.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                }
                Swal.fire('Deleted', 'All results deleted.', 'success');
            } catch(e) { Swal.fire('Error', e.message, 'error'); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        };

        // EXAMS logic preserved...
        const loadExams = () => {
            onSnapshot(query(collection(window.db, 'exams'), where('brand','==',window.user.brand)), snap => {
                document.getElementById('examListAdmin').innerHTML = snap.docs.map(d => {
                    const e = d.data();
                    return `<div class="card p-3 mb-2 bg-light border">
                        <div class="d-flex justify-content-between"><strong>${e.title}</strong><span>${e.resultDeclared?'Result Out':'Active'}</span></div>
                        <small class="text-muted">Class: ${e.class} | ${e.duration} mins</small>
                        <div class="mt-2 d-flex gap-1 flex-wrap">
                            <button onclick="unifiedEdit('${d.id}')" class="btn btn-sm btn-secondary flex-grow-1"><i class="fas fa-edit"></i> Edit</button>
                            <button onclick="trackExam('${d.id}','${e.class}')" class="btn btn-sm btn-primary flex-grow-1"><i class="fas fa-eye"></i> Track</button>
                            <button onclick="declare('${d.id}',${!e.resultDeclared})" class="btn btn-sm btn-info flex-grow-1">Result</button>
                            <button onclick="delEx('${d.id}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                }).join('');
                window.cachedExams = snap.docs.map(d => ({id: d.id, ...d.data()}));
            });
        };

        window.delEx = async(id) => {
            if(!confirm('Delete Exam? This will delete ALL questions and student results associated with it.')) return;
            const batch = writeBatch(window.db);
            batch.delete(doc(window.db, 'exams', id));
            (await getDocs(query(collection(window.db,'questions'),where('examId','==',id)))).docs.forEach(d => batch.delete(d.ref));
            (await getDocs(query(collection(window.db,'results'),where('examId','==',id)))).docs.forEach(d => batch.delete(d.ref));
            await batch.commit();
            Swal.fire('Deleted', 'Exam and all data removed.', 'success');
        };

        // Results with Filter logic
        const loadResults = () => { 
            onSnapshot(query(collection(window.db, 'results'), where('brand', '==', window.user.brand)), snap => { 
                window.allResults = snap.docs.map(d => ({id: d.id, ...d.data()}));
                applyResultFilters();
            }); 
        };

        window.renderResults = (list) => {
            document.getElementById('resultBody').innerHTML = list.map(res => { 
                // Recalculate rank based on current list context or global exam context? 
                // Ranking usually makes sense per exam. Let's calculate rank within the exam group OF THE FULL DATASET to keep it accurate even when filtered.
                const examGroup = window.allResults.filter(r => r.examId === res.examId).sort((a,b) => b.score - a.score);
                const rank = examGroup.findIndex(r => r.studentId === res.studentId) + 1;
                const timeStr = res.timeTaken ? `${Math.floor(res.timeTaken / 60)}m ${res.timeTaken % 60}s` : '-';
                
                return `<tr>
                    <td>${res.examTitle}</td>
                    <td>${res.studentName}<br><small class="text-muted">${res.studentId}</small></td>
                    <td>${res.score}/${res.total}</td>
                    <td>${timeStr}</td>
                    <td><span class="badge bg-primary">Rank #${rank}</span></td>
                    <td><span class="badge ${res.strikes >= 2 ? 'bg-danger' : 'bg-warning'} text-dark">${res.strikes || 0} Strikes</span></td>
                    <td>
                        <button onclick="viewResult('${res.id}')" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye"></i></button>
                        <button onclick="delResult('${res.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`; 
            }).join(''); 
        };

        window.applyResultFilters = () => {
            const txt = document.getElementById('frInput').value.toLowerCase();
            const cls = document.getElementById('frClass').value.toLowerCase();
            const sec = document.getElementById('frSection').value.toLowerCase();
            const roll = document.getElementById('frRoll').value.toLowerCase();
            const strikes = document.getElementById('frStrikes').value;
            const dob = document.getElementById('frDob').value;

            // Pre-map student details for faster lookup if not already efficient enough
            const studentMap = {};
            if(window.cachedStudents) {
                window.cachedStudents.forEach(s => studentMap[s.id] = s);
            }

            const filtered = window.allResults.filter(r => {
                // Get student details for this result
                const s = studentMap[r.studentId] || {}; // fallback to empty if student deleted

                // Filter logic
                const matchTxt = !txt || r.studentName.toLowerCase().includes(txt) || r.studentId.toLowerCase().includes(txt) || r.examTitle.toLowerCase().includes(txt);
                const matchCls = !cls || (s.class || '').toLowerCase().includes(cls);
                const matchSec = !sec || (s.section || '').toLowerCase().includes(sec);
                const matchRoll = !roll || (s.roll || '').toLowerCase().includes(roll);
                const matchStrikes = !strikes || (r.strikes || 0) >= parseInt(strikes);
                const matchDob = !dob || s.dob === dob;

                return matchTxt && matchCls && matchSec && matchRoll && matchStrikes && matchDob;
            });

            window.renderResults(filtered);
        };

        window.clearResultFilters = () => {
            document.getElementById('frInput').value = ''; document.getElementById('frClass').value = '';
            document.getElementById('frSection').value = ''; document.getElementById('frRoll').value = '';
            document.getElementById('frStrikes').value = ''; document.getElementById('frDob').value = '';
            window.renderResults(window.allResults);
        };

        // Original Edit, Save, and Question management remains...
        document.getElementById('createExamForm').onsubmit = async(e)=>{
            e.preventDefault(); 
            await addDoc(collection(window.db,'exams'),{
                brand:window.user.brand,
                title:document.getElementById('ceTitle').value,
                class:document.getElementById('ceClass').value,
                subject:document.getElementById('ceSubject').value,
                totalQuestions: parseInt(document.getElementById('ceTotalQ').value),
                duration: parseInt(document.getElementById('ceDuration').value),
                marksPerQ: parseInt(document.getElementById('ceMarks').value),
                instructions:document.getElementById('ceInst').value,
                resultDeclared:false, startTime:null, endTime:null, specialSchedules: {} 
            }); 
            bootstrap.Modal.getInstance(document.getElementById('createExamModal')).hide();
        };

        window.unifiedEdit = (id) => {
            window.activeExamId = id;
            const ex = window.cachedExams.find(e => e.id === id);
            document.getElementById('edId').value = id;
            document.getElementById('edTitle').value = ex.title;
            document.getElementById('edClass').value = ex.class;
            document.getElementById('edSubject').value = ex.subject;
            document.getElementById('edTotalQ').value = ex.totalQuestions || 0;
            document.getElementById('edDuration').value = ex.duration;
            document.getElementById('edMarks').value = ex.marksPerQ;
            document.getElementById('edInst').value = ex.instructions;
            document.getElementById('schStart').value = ex.startTime || '';
            document.getElementById('schEnd').value = ex.endTime || '';
            cancelEditQ();
            new bootstrap.Modal(document.getElementById('unifiedEditModal')).show();
            loadQ(id);
        };

        document.getElementById('editExamForm').onsubmit = async(e) => {
            e.preventDefault();
            await updateDoc(doc(window.db, 'exams', window.activeExamId), {
                title: document.getElementById('edTitle').value,
                class: document.getElementById('edClass').value,
                subject: document.getElementById('edSubject').value,
                totalQuestions: parseInt(document.getElementById('edTotalQ').value),
                duration: parseInt(document.getElementById('edDuration').value),
                marksPerQ: parseInt(document.getElementById('edMarks').value),
                instructions: document.getElementById('edInst').value
            });
            Swal.fire('Updated', 'Details saved', 'success');
        };

        window.saveSchedule = async() => { await updateDoc(doc(window.db,'exams',window.activeExamId), {startTime:document.getElementById('schStart').value, endTime:document.getElementById('schEnd').value}); Swal.fire('Saved','Schedule updated','success'); };
        
        document.getElementById('addQuesForm').onsubmit = async(e)=>{
            e.preventDefault();
            const qData = {
                examId:window.activeExamId, 
                text:document.getElementById('qText').value, 
                opts:[document.getElementById('opt1').value,document.getElementById('opt2').value,document.getElementById('opt3').value,document.getElementById('opt4').value], 
                correct:document.getElementById('qCorrect').value-1
            };
            const qId = document.getElementById('qEditId').value;
            if(qId) { await updateDoc(doc(window.db,'questions', qId), qData); Swal.fire('Updated', 'Question modified', 'success'); } 
            else { await addDoc(collection(window.db,'questions'), qData); }
            cancelEditQ();
        };

        window.prepEditQ = (id, txt, o1, o2, o3, o4, cor) => {
            document.getElementById('qEditId').value = id;
            document.getElementById('qText').value = txt;
            document.getElementById('opt1').value = o1; document.getElementById('opt2').value = o2;
            document.getElementById('opt3').value = o3; document.getElementById('opt4').value = o4;
            document.getElementById('qCorrect').value = parseInt(cor)+1;
            document.getElementById('btnSaveQ').innerText = "Update Question";
            document.getElementById('btnCancelQ').classList.remove('hide');
        };

        window.cancelEditQ = () => {
            document.getElementById('addQuesForm').reset();
            document.getElementById('qEditId').value = "";
            document.getElementById('btnSaveQ').innerText = "Add Question";
            document.getElementById('btnCancelQ').classList.add('hide');
        };

        const loadQ = (id) => onSnapshot(query(collection(window.db,'questions'),where('examId','==',id)), s => {
            document.getElementById('modalQuestionsList').innerHTML = s.docs.map(d => {
                const q = d.data();
                return `<li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-truncate" style="max-width: 70%;">${q.text}</small>
                        <div>
                            <button onclick="prepEditQ('${d.id}','${q.text.replace(/'/g, "\\'")}','${q.opts[0].replace(/'/g, "\\'")}','${q.opts[1].replace(/'/g, "\\'")}','${q.opts[2].replace(/'/g, "\\'")}','${q.opts[3].replace(/'/g, "\\'")}',${q.correct})" class="btn btn-sm btn-link"><i class="fas fa-edit"></i></button>
                            <button onclick="delQ('${d.id}')" class="btn btn-sm btn-link text-danger"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </li>`;
            }).join('');
        });

        window.delQ = async(id) => deleteDoc(doc(window.db,'questions',id));

        window.trackExam = async (id, cls) => {
            window.activeExamId = id;
            document.getElementById('trackExamId').value = id;
            document.getElementById('trackClass').innerText = cls;
            new bootstrap.Modal(document.getElementById('trackModal')).show();
            refreshTrack();
        };

        window.refreshTrack = async () => {
            const btn = document.getElementById('btnRefreshTrack');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            const eid = document.getElementById('trackExamId').value;
            const cls = document.getElementById('trackClass').innerText;
            const ex = window.cachedExams.find(e => e.id === eid);
            const now = new Date(); 
            
            const sSnap = await getDocs(query(collection(window.db, 'students'), where('brand','==',window.user.brand), where('class','==',cls)));
            const rSnap = await getDocs(query(collection(window.db, 'results'), where('examId','==',eid)));
            const results = rSnap.docs.map(d => d.data());
            
            document.getElementById('trackBody').innerHTML = sSnap.docs.map(doc => {
                const s = doc.data();
                const hasRes = results.find(r => r.studentId === s.id);
                const specialSched = ex.specialSchedules && ex.specialSchedules[s.id];
                
                let effectiveEnd = ex.endTime ? new Date(ex.endTime) : null;
                if (specialSched) {
                    effectiveEnd = new Date(specialSched.end);
                }

                let status = '<span class="badge bg-warning">Pending</span>';
                let action = '-';

                if(hasRes) {
                    status = '<span class="badge bg-success">Finished</span>';
                } else if(effectiveEnd && now > effectiveEnd) {
                    status = '<span class="badge bg-danger">Missed</span>';
                }
                
                if(specialSched) status += ' <span class="badge bg-info">Special Access</span>';
                
                const globalEnd = ex.endTime ? new Date(ex.endTime) : null;
                const isGlobalMissed = globalEnd && now > globalEnd;

                if(!hasRes && (isGlobalMissed || specialSched)) {
                     action = `<button onclick="allowReattempt('${s.id}')" class="btn btn-sm btn-outline-primary">${specialSched ? 'Update' : 'Re-schedule'}</button>`;
                }
                
                return `<tr><td>${s.id}</td><td>${s.name}</td><td>${status}</td><td>${action}</td></tr>`;
            }).join('');
            
            btn.innerHTML = originalText;
        };

        window.allowReattempt = async (sid) => {
            const { value: formValues } = await Swal.fire({
                title: 'Set Special Schedule',
                html: `
                    <label>New Start Time</label><input id="swal-start" type="datetime-local" class="swal2-input">
                    <label>New End Time</label><input id="swal-end" type="datetime-local" class="swal2-input">
                `,
                focusConfirm: false,
                preConfirm: () => {
                    return [
                        document.getElementById('swal-start').value,
                        document.getElementById('swal-end').value
                    ]
                }
            });

            if (formValues && formValues[0] && formValues[1]) {
                const mapKey = `specialSchedules.${sid}`;
                const updatePayload = {};
                updatePayload[mapKey] = { start: formValues[0], end: formValues[1] };
                
                await updateDoc(doc(window.db, 'exams', window.activeExamId), updatePayload);
                Swal.fire('Updated', 'Student schedule updated.', 'success');
                refreshTrack();
            }
        };

        window.declare = async(id,v) => updateDoc(doc(window.db,'exams',id),{resultDeclared:v});
        window.delResult = async(id) => { if(confirm('Delete this result record?')) await deleteDoc(doc(window.db, 'results', id)); };

        window.viewResult = async(resId) => {
            const rDoc = await getDocs(query(collection(window.db,'results'), where('__name__','==',resId)));
            const r = rDoc.docs[0].data();
            const qSnap = await getDocs(query(collection(window.db,'questions'), where('examId','==',r.examId)));
            const questions = qSnap.docs.map(d => d.data());
            const timeStr = r.timeTaken ? `${Math.floor(r.timeTaken / 60)}m ${r.timeTaken % 60}s` : 'N/A';
            let html = `<div class="text-center mb-3"><h5>${r.studentName} (${r.studentId})</h5><h3>Score: ${r.score} / ${r.total}</h3><p>Time Taken: ${timeStr}</p></div><hr>`;
            
            questions.forEach((q, i) => {
                let userAns = -1;
                if (r.detailedAnswers && r.detailedAnswers[q.id] !== undefined) {
                    userAns = r.detailedAnswers[q.id];
                } else if (r.answers && Array.isArray(r.answers)) {
                    userAns = r.answers[i];
                }

                const isCorrect = userAns === q.correct;
                const userText = userAns > -1 ? q.opts[userAns] : 'Not Answered';
                const corrText = q.opts[q.correct];
                html += `<div class="mb-3 p-3 border rounded ${isCorrect ? 'correct-ans' : 'wrong-ans'}"><strong>Q. ${q.text}</strong><br><small>Your Ans: ${userText} ${isCorrect ? '' : ''}</small><br>${!isCorrect ? `<small class="text-success fw-bold">Correct Ans: ${corrText}</small>` : ''}</div>`;
            });
            document.getElementById('viewResultBody').innerHTML = html;
            new bootstrap.Modal(document.getElementById('viewResultModal')).show();
        };

        // --- Support / Chat Logic ---
        const loadSupport = () => {
            onSnapshot(query(collection(window.db, 'tickets'), where('brand', '==', window.user.brand)), snap => {
                const tickets = snap.docs.map(d => ({id: d.id, ...d.data()}));
                tickets.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));

                document.getElementById('ticketList').innerHTML = tickets.map(t => {
                    const active = activeTicketId === t.id ? 'active' : '';
                    return `<button onclick="openTicket('${t.id}', '${t.studentName}')" class="list-group-item list-group-item-action ${active}">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${t.studentName}</h6>
                            <small>${t.updatedAt?.toDate().toLocaleDateString()}</small>
                        </div>
                        <small class="text-truncate d-block text-muted" style="max-width: 200px;">${t.lastMessage}</small>
                    </button>`;
                }).join('');
            });
        };

        window.openTicket = (tId, sName) => {
            activeTicketId = tId;
            document.getElementById('adminChatPlaceholder').classList.add('hide');
            document.getElementById('adminChatBox').classList.remove('hide');
            document.getElementById('activeChatUser').innerText = sName;
            
            if(chatUnsub) chatUnsub();
            chatUnsub = onSnapshot(query(collection(window.db, 'tickets', tId, 'messages'), orderBy('timestamp', 'asc')), snap => {
                const d = document.getElementById('adminChatMsgs');
                d.innerHTML = snap.docs.map(doc => {
                    const m = doc.data();
                    return `<div class="d-flex flex-column"><div class="msg ${m.sender==='admin'?'admin':'student'}">${m.text}</div><small class="text-muted" style="font-size:10px; align-self: ${m.sender==='admin'?'flex-end':'flex-start'}">${m.timestamp?.toDate().toLocaleTimeString()||''}</small></div>`;
                }).join('');
                d.scrollTop = d.scrollHeight;
            });
            loadSupport();
        };

        window.adminSend = async () => {
            const txt = document.getElementById('adminChatInput').value.trim();
            if(!txt || !activeTicketId) return;
            await addDoc(collection(window.db, 'tickets', activeTicketId, 'messages'), { text: txt, sender: 'admin', timestamp: serverTimestamp() });
            await updateDoc(doc(window.db, 'tickets', activeTicketId), { lastMessage: txt, updatedAt: serverTimestamp() });
            document.getElementById('adminChatInput').value = '';
        };

        window.deleteTicket = async () => {
            if(!activeTicketId || !confirm('Delete this support chat permanently?')) return;
            const batch = writeBatch(window.db);
            (await getDocs(collection(window.db, 'tickets', activeTicketId, 'messages'))).forEach(d => batch.delete(d.ref));
            batch.delete(doc(window.db, 'tickets', activeTicketId));
            await batch.commit();
            
            activeTicketId = null;
            document.getElementById('adminChatPlaceholder').classList.remove('hide');
            document.getElementById('adminChatBox').classList.add('hide');
        };

        init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>
